# Fabric model

The goal is to build math model for procedural rendering of fabric with yarn-level detail.

That should suppport most common woven and knitted fabric structures:
- weaving:
  - plain
  - twill with various parameters of up/down and shift
- knitting:
  - stockinette
  - reverse stockinette
  - garter
  - rib
  - seed and moss

Final implementation should achieve:
- realistic yarns shape
- smoothness of yarns across the fabric
- it should run in real-time without simulation phases
- artistic control of each separate yarn
- artistic control of ovetall fabric structure on different level of details
- prefer artistic parameters over physiscs

Requirements for math:
- local calculations, based on immediate surrounding of calculated points
- numerically stable computations
- preferring closed-form solutions and avoiding numerical methods
- ideally, avoiding any iterative or recursive calculations

Final target is OpenSL language shaders mapping texure coordinates to surface elevation/displacement or intensity/color.
The shaders supposed to run in a node-controlled environment such as Blender3d.

## Base idea

The base idea is to use splines to model yarn shapes.

The splines should provide at least $C^1$ continuity, so that neighbour segments connect smoothly along with their textures.

## Workflow

1. fabric is formed from regular grid of knots
2. knots determine intersecting segments of yarn aligned with neighbour knots
3. segments of yarn are modelled as fragments spline curves
4. the curves are beveled to produce cylindrical surface in polar coordinates to be textured with fibers

### 1. Patterns

Base grid can be based on UV coords. Any pattern of knots can be generated by standard operations on integers.

Irregular patterns can be sampled from a discrete-color raster image, provided it is sampled along with neighbour pixels.

**A challenge** is to sample pattern and customization parameters from neighbour knots.
For a knot in a (u,v) grid cell, patterns should also provide params for additional 4 neighbours (u±1, v±1)

**Another challenge** is to track of each yarn running across grid so it can be customized individually.

### 2. Knots

Basic knots contain 2 intersecting arcs. For knitting, a whole loop can be subdivided into 4 subgrid each by 2 arcs.

Main keypoints of a knot is the point of intersection/twist for each arc.
Edges of the arcs should be aligned with neighbour knots.

There are 2 basic knots for weaving and 2 for knitting:
- weaving:
  - weft-facing
  - warp-facing
- knitting:
  - knit stitch (*2 halves)
  - purl stitch (*2 halves)

Each arcs of knots should fit completely into their grid cells. That should accomodate thicknes of

**Main challenge** is to align the knots with neighbours.

### 3. Yarn

Yarn can be modelled by *some kind of* splines, interpolating or approximating key points of knots.

To be physically correct according to tension stuff, the splines should be at least 3rd degree.
It might be visually acceptable to approximate it with quadratic splines to simplify calculations.

**Main challenge** is to agree the curves with neighbour knots in C^0 and G^1

### 4. Texture

The texture should be mapped to cylinder polar cordinates to produce pipe-like visuals.
The coordinates should either wrap or ideally be continuous at edges of segments.

The polar coordinates are:
- $s$: length along the curve -> texture $u$
- $r$: distance from axis -> texture $v$ for flat mapping
- $a$: angle above horizontal surface -> texture $v$ for cylindrical wrapping

The arclength is nearly impossible to calculate, and it's probably ok to approximate them with curve parameter $t$.

With regular grid lengths of segments in knos are equal and can be mapped to $[0, 1]$.
That comes natural with $t$ approximation.

**A challenge** is to find projection (closest) point on curve for each UV point.
This requires solving equation of degree $2d-1$

**Another challenge** is that thick yarn can overflow a grid cell.
Also, the pipe surface at the edges should not get cut.